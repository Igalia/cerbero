# -*- Mode: Python -*- vi:si:et:sw=4:sts=4:ts=4:syntax=python

from cerbero.utils import android, shell

class Recipe(recipe.Recipe):
    name = 'wpewebkit'
    version = '2.37.91'
    stype = SourceType.TARBALL
    btype = BuildType.CMAKE
    url = f'https://wpewebkit.org/releases/wpewebkit-{version}.tar.xz'
    tarball_checksum = '0e7e907367366797f657c4ba793988b15e6c5fff747a449521ea264c55f6d614'
    deps = [
        'icu',
        'cairo',
        'freetype',
        'gettext',
        'gstreamer-1.0',
        'gst-plugins-base-1.0',
        'gst-plugins-good-1.0',
        'gst-plugins-bad-1.0',
        'harfbuzz',
        'libepoxy',
        'libgcrypt',
        'libjpeg-turbo',
        'libpng',
        'libsoup',
        'libxslt',
        'libwebp',
        'libwpe',
        'openjpeg',
    ]
    platform_deps = {Platform.ANDROID: ['gnustl']}
    # TODO: support accessibility and woff2
    configure_options = '-DPORT=WPE \
                        -DENABLE_ACCESSIBILITY=OFF \
                        -DENABLE_BUBBLEWRAP_SANDBOX=OFF \
                        -DENABLE_DOCUMENTATION=OFF \
                        -DENABLE_INTROSPECTION=OFF \
                        -DENABLE_JOURNALD_LOG=OFF \
                        -DENABLE_WEBDRIVER=OFF \
                        -DUSE_GSTREAMER_GL=ON \
                        -DUSE_GSTREAMER_NATIVE_AUDIO=ON \
                        -DUSE_GSTREAMER_NATIVE_VIDEO=ON \
                        -DUSE_LCMS=OFF \
                        -DUSE_SOUP2=ON \
                        -DUSE_WOFF2=OFF \
                        -DWPE_ENABLE_PROCESS=1 \
                        -DHAVE_PTHREAD_NP_H=OFF \
                        -Dis_android=1 \
                        -DCMAKE_SYSTEM_NAME=Linux \
                        -DCMAKE_BUILD_TYPE=Release'
    cmake_generator = 'ninja'

    files_libs = [
        'libWPEWebKit-1.0'
    ]

    files_misc = [
        'lib/wpe-webkit-1.0/libWPEWebInspectorResources.so',
        'lib/wpe-webkit-1.0/injected-bundle/libWPEInjectedBundle.so'
    ]

    files_devel = [
        'include/wpe-webkit-1.0/jsc/JSCAutocleanups.h',
        'include/wpe-webkit-1.0/jsc/JSCClass.h',
        'include/wpe-webkit-1.0/jsc/JSCContext.h',
        'include/wpe-webkit-1.0/jsc/JSCDefines.h',
        'include/wpe-webkit-1.0/jsc/JSCException.h',
        'include/wpe-webkit-1.0/jsc/JSCOptions.h',
        'include/wpe-webkit-1.0/jsc/JSCValue.h',
        'include/wpe-webkit-1.0/jsc/JSCVersion.h',
        'include/wpe-webkit-1.0/jsc/JSCVirtualMachine.h',
        'include/wpe-webkit-1.0/jsc/JSCWeakValue.h',
        'include/wpe-webkit-1.0/jsc/jsc.h',
        'include/wpe-webkit-1.0/wpe/WebKitApplicationInfo.h',
        'include/wpe-webkit-1.0/wpe/WebKitAuthenticationRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitAutocleanups.h',
        'include/wpe-webkit-1.0/wpe/WebKitAutomationSession.h',
        'include/wpe-webkit-1.0/wpe/WebKitBackForwardList.h',
        'include/wpe-webkit-1.0/wpe/WebKitBackForwardListItem.h',
        'include/wpe-webkit-1.0/wpe/WebKitColor.h',
        'include/wpe-webkit-1.0/wpe/WebKitConsoleMessage.h',
        'include/wpe-webkit-1.0/wpe/WebKitContextMenu.h',
        'include/wpe-webkit-1.0/wpe/WebKitContextMenuActions.h',
        'include/wpe-webkit-1.0/wpe/WebKitContextMenuItem.h',
        'include/wpe-webkit-1.0/wpe/WebKitCookieManager.h',
        'include/wpe-webkit-1.0/wpe/WebKitCredential.h',
        'include/wpe-webkit-1.0/wpe/WebKitDOMDefines.h',
        'include/wpe-webkit-1.0/wpe/WebKitDOMDocument.h',
        'include/wpe-webkit-1.0/wpe/WebKitDOMElement.h',
        'include/wpe-webkit-1.0/wpe/WebKitDOMNode.h',
        'include/wpe-webkit-1.0/wpe/WebKitDOMObject.h',
        'include/wpe-webkit-1.0/wpe/WebKitDefines.h',
        'include/wpe-webkit-1.0/wpe/WebKitDeviceInfoPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitDownload.h',
        'include/wpe-webkit-1.0/wpe/WebKitEditingCommands.h',
        'include/wpe-webkit-1.0/wpe/WebKitEditorState.h',
        'include/wpe-webkit-1.0/wpe/WebKitEnumTypes.h',
        'include/wpe-webkit-1.0/wpe/WebKitError.h',
        'include/wpe-webkit-1.0/wpe/WebKitFaviconDatabase.h',
        'include/wpe-webkit-1.0/wpe/WebKitFileChooserRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitFindController.h',
        'include/wpe-webkit-1.0/wpe/WebKitFormSubmissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitFrame.h',
        'include/wpe-webkit-1.0/wpe/WebKitGeolocationManager.h',
        'include/wpe-webkit-1.0/wpe/WebKitGeolocationPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitHitTestResult.h',
        'include/wpe-webkit-1.0/wpe/WebKitInputMethodContext.h',
        'include/wpe-webkit-1.0/wpe/WebKitInstallMissingMediaPluginsPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitJavascriptResult.h',
        'include/wpe-webkit-1.0/wpe/WebKitMediaKeySystemPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitMemoryPressureSettings.h',
        'include/wpe-webkit-1.0/wpe/WebKitMimeInfo.h',
        'include/wpe-webkit-1.0/wpe/WebKitNavigationAction.h',
        'include/wpe-webkit-1.0/wpe/WebKitNavigationPolicyDecision.h',
        'include/wpe-webkit-1.0/wpe/WebKitNetworkProxySettings.h',
        'include/wpe-webkit-1.0/wpe/WebKitNotification.h',
        'include/wpe-webkit-1.0/wpe/WebKitNotificationPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitOptionMenu.h',
        'include/wpe-webkit-1.0/wpe/WebKitOptionMenuItem.h',
        'include/wpe-webkit-1.0/wpe/WebKitPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitPlugin.h',
        'include/wpe-webkit-1.0/wpe/WebKitPolicyDecision.h',
        'include/wpe-webkit-1.0/wpe/WebKitRectangle.h',
        'include/wpe-webkit-1.0/wpe/WebKitResponsePolicyDecision.h',
        'include/wpe-webkit-1.0/wpe/WebKitScriptDialog.h',
        'include/wpe-webkit-1.0/wpe/WebKitScriptWorld.h',
        'include/wpe-webkit-1.0/wpe/WebKitSecurityManager.h',
        'include/wpe-webkit-1.0/wpe/WebKitSecurityOrigin.h',
        'include/wpe-webkit-1.0/wpe/WebKitSettings.h',
        'include/wpe-webkit-1.0/wpe/WebKitURIRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitURIResponse.h',
        'include/wpe-webkit-1.0/wpe/WebKitURISchemeRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitURISchemeResponse.h',
        'include/wpe-webkit-1.0/wpe/WebKitURIUtilities.h',
        'include/wpe-webkit-1.0/wpe/WebKitUserContent.h',
        'include/wpe-webkit-1.0/wpe/WebKitUserContentFilterStore.h',
        'include/wpe-webkit-1.0/wpe/WebKitUserContentManager.h',
        'include/wpe-webkit-1.0/wpe/WebKitUserMediaPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitUserMessage.h',
        'include/wpe-webkit-1.0/wpe/WebKitVersion.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebContext.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebEditor.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebExtension.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebExtensionAutocleanups.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebHitTestResult.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebPage.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebProcessEnumTypes.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebResource.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebView.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebViewBackend.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebViewSessionState.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebsiteData.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebsiteDataAccessPermissionRequest.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebsiteDataManager.h',
        'include/wpe-webkit-1.0/wpe/WebKitWebsitePolicies.h',
        'include/wpe-webkit-1.0/wpe/WebKitWindowProperties.h',
        'include/wpe-webkit-1.0/wpe/webkit-web-extension.h',
        'include/wpe-webkit-1.0/wpe/webkit.h',
        'include/wpe-webkit-1.0/wpe/webkitdom.h',
        'lib/pkgconfig/wpe-webkit-1.0.pc',
        'lib/pkgconfig/wpe-web-extension-1.0.pc'
    ]

    files_libexec = [
        'libexec/wpe-webkit-1.0/WPENetworkProcess',
        'libexec/wpe-webkit-1.0/WPEWebProcess',
    ]

    def prepare(self):
        self.configure_options += f' \
            -DICU_ROOT={self.config.prefix} \
            -DZLIB_ROOT={self.config.prefix} \
            -DFREETYPE_LIBRARY={self.config.prefix}/lib/libfreetype.so \
            -DFREETYPE_INCLUDE_DIR_ft2build={self.config.prefix}/include/freetype2 \
            -DFREETYPE_INCLUDE_DIR_freetype2={self.config.prefix}/include/freetype2 \
            -DJPEG_LIBRARY={self.config.prefix}/lib/libjpeg.so \
            -DJPEG_INCLUDE_DIR={self.config.prefix}/include \
            -DPNG_LIBRARY={self.config.prefix}/lib/libpng.so \
            -DPNG_INCLUDE_DIR={self.config.prefix}/include \
            '
        if self.config.target_platform in (Platform.ANDROID):
            arch_src_name = self.config.target_arch
            if self.config.target_arch == Architecture.ARMv7:
                arch_src_name = 'arm'
            self.configure_options += ' -DCMAKE_SYSTEM_PROCESSOR=' + arch_src_name
            self.append_env('LDFLAGS', '-landroid -llog -lm -lintl -lc++_shared -O2')
            # Android libc does not have bcmp()
            self.append_env('CXXFLAGS', ' -Dbcmp=memcmp ')
            self.append_env('CFLAGS', ' -Dbcmp=memcmp ')
            # XXX: CMake fails to check for this properly
            self.append_env('CXXFLAGS', ' -DHAVE_MISSING_STD_FILESYSTEM_PATH_CONSTRUCTOR=1')
            # Placeholder to allow enabling debug externally
            self.append_env('WEBKIT_DEBUG', '')
            self.patches += [
                'wpewebkit/0001-Merge-254093-main-GStreamer-MediaStream-Build-failin.patch',
                'wpewebkit/0002-Merge-254097-main-GLIB-WheelEvent-phase-ended-has-to.patch',
                'wpewebkit/0003-Merge-254099-main-WPE-Kinetic-scrolling-doesn-t-work.patch',
                'wpewebkit/0004-Merge-254121-main-GLib-Fix-build-with-CMake-3.17.patch',
                'wpewebkit/0005-Merge-254142-main-GStreamer-MediaPlayerPrivateGStrea.patch',
                'wpewebkit/0006-Merge-254152-main-AX-AccessibilityObject-replacedNod.patch',
                'wpewebkit/0007-Merge-254038-main-ConicGradient-angle-should-start-a.patch',
                'wpewebkit/0008-Merge-254165-main-enumerateDevices-may-return-filter.patch',
                'wpewebkit/0009-Merge-254213-main-Revert-252943-main-for-causing-con.patch',
                'wpewebkit/0010-Merge-254223-main-GStreamer-WebAudio-drums-demo-make.patch',
                'wpewebkit/0011-Merge-254220-main-CoordinatedGraphics-fix-includes-w.patch',
                'wpewebkit/0013-Merge-254232-main-WPE-GTK-web-process-terminated-sig.patch',
                'wpewebkit/0014-Merge-254245-main-X-Frame-Options-HTTP-headers-with-.patch',
                'wpewebkit/0015-Merge-254259-main-Call-prepareForDisplayWithPaint-so.patch',
                'wpewebkit/0016-Merge-254254-main-imported-w3c-web-platform-tests-Fi.patch',
                'wpewebkit/0017-Merge-254253-main-border-radius-clipping-of-composit.patch',
                'wpewebkit/0018-Merge-254183-main-GTK-Crash-in-Nicosia-GC3DLayer-mak.patch',
                'wpewebkit/0019-Android-logging-macro.patch',
                'wpewebkit/0020-Android-remove-uses-of-shm_open-and-shm_unlink.patch',
                'wpewebkit/0021-Implement-Android-WebProcess-and-NetworkProcess-entr.patch',
                'wpewebkit/0022-Scroll-related-changes.patch',
                'wpewebkit/0023-Remove-absolute-path-from-libWPEInjectedBundle.so-on.patch',
                'wpewebkit/0024-Workaround-for-Android-emulator-samplerExternalOES-p.patch',
                'wpewebkit/0025-Enable-libwpe-process-management-API.patch',
            ]
        else:
            self.append_env('LDFLAGS', '-lrt')
            self.configure_options += ' -DCMAKE_SYSTEM_PROCESSOR=' + self.config.target_arch
